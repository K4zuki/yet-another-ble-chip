## mbed(TM)プラットフォームを利用する
### ｴｪｪｪｪﾝﾍﾞｯﾄﾞ!とは

### イカ醤油ポッポ焼きの解説
イカ醤油ポッポ焼き（Ika Shouyu Poppo-yaki a.k.a. *ISP*）は@tedd_okano氏が [ツイッターのノリに任せて][1] 作ってしまった[プログラム][2]です。LPCマイコンシリーズ（の一部）向けのライタプログラムで、ターゲットデバイス用コンパイル済バイナリを、mbed LPC1768/11U24 からUARTを使って書き込みます。  


### イカ醤油もどきを実装する
#### DA14580のブート手順
_(＊)この部分の詳細は **AN-B-001 DA1458x Booting from serial interfaces** を参照してください_  
DA14580は、電源リセットがかかるとまずOTPに書き込まれたプログラムがあるかどうかを特定のアドレスを読むことで確認します。この時にプログラムが書き込まれていない時=OTPが空だと判定された時、DA14580は以下の順序で外部シリアルインターフェースからプログラムのロードを試みます：
- 外部SPIマスタ（2つのピン組み合わせ）
- **UART(9600/57600/115200 baud、4つのピン組み合わせ)**
- SPIスレーブ（SPIフラッシュメモリなど）
- I2Cスレーブ（I2C EEPROMメモリなど、4つのピン組み合わせ）  
- これらすべてが失敗した場合はSWDデバッガからの入力を待ちます。


#### UARTブート仕様
ここでは元祖イカ醤油と同様にUARTシリアル通信でコンパイル済バイナリをロードする方法を示しますが、まずはUARTブートの仕様を書いておきます。  
使用されるピンはPORT0の８ピンで、P0_0から２ピンずつペアになります。

|580 TX|580 RX|BaudRate|
|:--:|:--:|:--:|
|P0_0|P0_1|57600|
|P0_2|P0_3|115200|
|P0_4|P0_5|57600|
|P0_6|P0_7|9600|

すべての組み合わせについて、8ビット、パリティなし、1ストップビット（8N1）です。

##### プロトコル手順
UARTでのブートにはXMODEMによく似た手順を用います（残念ながら筆者はXMODEMをよく知りませんが、各予約語がXMODEMと一致するのは見つけられました）
* mbed LPC1768のp9,p10にDA14580のP0_4/P0_5を接続しておきます。

|#|580 P0_4(mbed p10)|580 P0_5(mbed p9)|comment|
|:--:|:--:|:--:|:--:|
|0|STX = 0x02| |Start TX, STX|
|1| |SOH = 0x01|Start of Header, SOH|
|2| |LEN_LSB|バイナリサイズ(LSB)|
|3| |LEN_MSB|バイナリサイズ(MSB)|
|4|ACK = 0x06 or NACK = 0x15 | | |
|5~N| |バイナリデータ|各バイトデータのXORをとってCRCを作っておく。最初は0x00とXORする|
|N+1|CRC| | |
|N+2| |ACK = 0x06|-|

mbed視点で見ると、
* LocalFileSystemに580用のバイナリを用意しておく
* バイナリファイルのサイズを確認して変数に入れておく
* DA14580をリセットさせる
* 0x02を受け取るまで待つ(タイムアウトを設定しておく)
  * 受け取ったら0x01、ファイルサイズ(LSB,MSBの順)を返送する
  * 1バイト受け取るまで待つ(タイムアウトを設定しておく)
    * 受け取ったものがACKならバイナリファイルを先頭から送る
      * このとき各バイトのXORをとる(ローカルCRC)。最初は0x00とのXORをとる。
    * 全て送ったあとCRCの返送を待つ(リモートCRC)
    * ローカルCRCとリモートCRCが一致したらACKを送って書き込み成功

となります。

[1]: https://developer.mbed.org/users/okano/notebook/how_the_ika_shouyu_poppo_yaki_born/

[2]: https://developer.mbed.org/users/okano/code/ika_shouyu_poppoyaki/wiki/Homepage
